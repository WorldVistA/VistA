EMERGENCY Released PSB*3*94 SEQ #74
Extracted from mail message
**KIDS**:PSB*3.0*94^

**INSTALL NAME**
PSB*3.0*94
"BLD",9155,0)
PSB*3.0*94^BAR CODE MED ADMIN^0^3160503^y
"BLD",9155,4,0)
^9.64PA^^
"BLD",9155,6.3)
4
"BLD",9155,"INID")
^y
"BLD",9155,"INIT")
EN^PSB394P
"BLD",9155,"KRN",0)
^9.67PA^779.2^20
"BLD",9155,"KRN",.4,0)
.4
"BLD",9155,"KRN",.401,0)
.401
"BLD",9155,"KRN",.402,0)
.402
"BLD",9155,"KRN",.403,0)
.403
"BLD",9155,"KRN",.5,0)
.5
"BLD",9155,"KRN",.84,0)
.84
"BLD",9155,"KRN",3.6,0)
3.6
"BLD",9155,"KRN",3.8,0)
3.8
"BLD",9155,"KRN",9.2,0)
9.2
"BLD",9155,"KRN",9.8,0)
9.8
"BLD",9155,"KRN",9.8,"NM",0)
^9.68A^1^1
"BLD",9155,"KRN",9.8,"NM",1,0)
PSBML^^0^B133370450
"BLD",9155,"KRN",9.8,"NM","B","PSBML",1)

"BLD",9155,"KRN",19,0)
19
"BLD",9155,"KRN",19.1,0)
19.1
"BLD",9155,"KRN",101,0)
101
"BLD",9155,"KRN",409.61,0)
409.61
"BLD",9155,"KRN",771,0)
771
"BLD",9155,"KRN",779.2,0)
779.2
"BLD",9155,"KRN",870,0)
870
"BLD",9155,"KRN",8989.51,0)
8989.51
"BLD",9155,"KRN",8989.52,0)
8989.52
"BLD",9155,"KRN",8994,0)
8994
"BLD",9155,"KRN","B",.4,.4)

"BLD",9155,"KRN","B",.401,.401)

"BLD",9155,"KRN","B",.402,.402)

"BLD",9155,"KRN","B",.403,.403)

"BLD",9155,"KRN","B",.5,.5)

"BLD",9155,"KRN","B",.84,.84)

"BLD",9155,"KRN","B",3.6,3.6)

"BLD",9155,"KRN","B",3.8,3.8)

"BLD",9155,"KRN","B",9.2,9.2)

"BLD",9155,"KRN","B",9.8,9.8)

"BLD",9155,"KRN","B",19,19)

"BLD",9155,"KRN","B",19.1,19.1)

"BLD",9155,"KRN","B",101,101)

"BLD",9155,"KRN","B",409.61,409.61)

"BLD",9155,"KRN","B",771,771)

"BLD",9155,"KRN","B",779.2,779.2)

"BLD",9155,"KRN","B",870,870)

"BLD",9155,"KRN","B",8989.51,8989.51)

"BLD",9155,"KRN","B",8989.52,8989.52)

"BLD",9155,"KRN","B",8994,8994)

"BLD",9155,"QDEF")
^^^^NO^^^^NO^^NO
"BLD",9155,"QUES",0)
^9.62^^
"BLD",9155,"REQB",0)
^9.611^2^2
"BLD",9155,"REQB",1,0)
PSB*3.0*72^1
"BLD",9155,"REQB",2,0)
PSB*3.0*79^1
"BLD",9155,"REQB","B","PSB*3.0*72",1)

"BLD",9155,"REQB","B","PSB*3.0*79",2)

"INIT")
EN^PSB394P
"MBREQ")
0
"PKG",477,-1)
1^1
"PKG",477,0)
BAR CODE MED ADMIN^PSB^BAR CODE MEDICATION ADMINISTRATION
"PKG",477,20,0)
^9.402P^^
"PKG",477,22,0)
^9.49I^1^1
"PKG",477,22,1,0)
3.0^3040224^3040311^66481
"PKG",477,22,1,"PAH",1,0)
94^3160503
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
2
"RTN","PSB394P")
0^^B8862587^n/a
"RTN","PSB394P",1,0)
PSB394P ;MNT/BJR - Move Units Given field to Units Ordered ; 
"RTN","PSB394P",2,0)
 ;;3.0;BAR CODE MED ADMIN;**94**;APR 2016;Build 4
"RTN","PSB394P",3,0)
 ;Per VHA Directive 2004-038 (or future revisions regarding same), this routine should not be modified.
"RTN","PSB394P",4,0)
 ;
"RTN","PSB394P",5,0)
 Q
"RTN","PSB394P",6,0)
EN ;This routine will move the date in the units given field to the units ordered field for patch PSB*3*94
"RTN","PSB394P",7,0)
 N DR,DA,DIE,XX,SDT
"RTN","PSB394P",8,0)
 D MES^XPDUTL("")
"RTN","PSB394P",9,0)
 D MES^XPDUTL("*** PSB*3*94 Post Install Running ***")
"RTN","PSB394P",10,0)
 D MES^XPDUTL("")
"RTN","PSB394P",11,0)
 N X,PSBIEN,PSBADD,PSBDOSE,PSBSTAT,PSBSOL
"RTN","PSB394P",12,0)
 D NOW^%DTC S ^XTMP("PSB94P",0)=$$FMADD^XLFDT(X,30)_"^"_X_"^"_"PSB*3.0*94 Changed Entries"
"RTN","PSB394P",13,0)
 S XX=0 F  S XX=$O(^PSB(53.79,"AEDT",XX)) Q:XX'>0  S SDT=3160331.5959 F  S SDT=$O(^PSB(53.79,"AEDT",XX,SDT)) Q:SDT'>0  S PSBIEN=0 F  S PSBIEN=$O(^PSB(53.79,"AEDT",XX,SDT,PSBIEN)) Q:PSBIEN'>0  D
"RTN","PSB394P",14,0)
 .I $G(^PSB(53.79,PSBIEN,.6,0))'="" S PSBADD=0 F  S PSBADD=$O(^PSB(53.79,PSBIEN,.6,PSBADD)) Q:'PSBADD  D
"RTN","PSB394P",15,0)
 ..M:'$D(^XTMP("PSB94P",PSBIEN,.6)) ^XTMP("PSB94P",PSBIEN,.6)=^PSB(53.79,PSBIEN,.6) S PSBDOSE=$$GET1^DIQ(53.796,PSBADD_","_PSBIEN,.03),PSBSTAT=$$GET1^DIQ(53.79,PSBIEN,.09,"I")
"RTN","PSB394P",16,0)
 ..I PSBDOSE'="" S DR=".02///^S X=PSBDOSE",DIE="^PSB(53.79,"_PSBIEN_",.6,",DA(1)=PSBIEN,DA=PSBADD D ^DIE K DR,DA,DIE
"RTN","PSB394P",17,0)
 ..I PSBSTAT'="G",PSBSTAT'="RM",PSBSTAT'="I",PSBSTAT'="C" S DR=".03///^S X=""@""",DIE="^PSB(53.79,"_PSBIEN_",.6,",DA(1)=PSBIEN,DA=PSBADD D ^DIE K DR,DA,DIE
"RTN","PSB394P",18,0)
 .I $G(^PSB(53.79,PSBIEN,.7,0))'="" S PSBSOL=0 F  S PSBSOL=$O(^PSB(53.79,PSBIEN,.7,PSBSOL)) Q:'PSBSOL  D
"RTN","PSB394P",19,0)
 ..M:'$D(^XTMP("PSB94P",PSBIEN,.7)) ^XTMP("PSB94P",PSBIEN,.7)=^PSB(53.79,PSBIEN,.7) S PSBDOSE=$$GET1^DIQ(53.797,PSBSOL_","_PSBIEN,.03),PSBSTAT=$$GET1^DIQ(53.79,PSBIEN,.09,"I")
"RTN","PSB394P",20,0)
 ..I PSBDOSE'="" S DR=".02///^S X=PSBDOSE",DIE="^PSB(53.79,"_PSBIEN_",.7,",DA(1)=PSBIEN,DA=PSBSOL D ^DIE K DR,DA,DIE
"RTN","PSB394P",21,0)
 ..I PSBSTAT'="G",PSBSTAT'="RM",PSBSTAT'="I",PSBSTAT'="C" S DR=".03///^S X=""@""",DIE="^PSB(53.79,"_PSBIEN_",.7,",DA(1)=PSBIEN,DA=PSBSOL D ^DIE K DR,DA,DIE
"RTN","PSB394P",22,0)
 D MES^XPDUTL("")
"RTN","PSB394P",23,0)
 D MES^XPDUTL("*** PSB*3*94 Post Install Complete ***")
"RTN","PSB394P",24,0)
 D MES^XPDUTL("*** You may review global ^XTMP(""PSB94P"") for a list of entries modified ***")
"RTN","PSB394P",25,0)
 D MES^XPDUTL("")
"RTN","PSB394P",26,0)
 Q
"RTN","PSBML")
0^1^B133370450^B134214064
"RTN","PSBML",1,0)
PSBML ;BIRMINGHAM/EFC-BCMA,ASMR/BL MED LOG FUNCTIONS ; 12/3/15 4:08pm
"RTN","PSBML",2,0)
 ;;3.0;BAR CODE MED ADMIN;**6,3,4,9,11,13,25,45,33,52,70,72,79,94**;Mar 2004;Build 4
"RTN","PSBML",3,0)
 ;Per VA Directive 6402, this routine should not be modified.
"RTN","PSBML",4,0)
 ; Reference/IA
"RTN","PSBML",5,0)
 ; ^DPT/10035
"RTN","PSBML",6,0)
 ; DIC(42/10039
"RTN","PSBML",7,0)
 ; DIC(42/2440
"RTN","PSBML",8,0)
 ; File 200/10060
"RTN","PSBML",9,0)
 ; EN^PSJBCMA3/3320
"RTN","PSBML",10,0)
 ; $$SITE^VASITE/10112
"RTN","PSBML",11,0)
 ; ^XUSEC(/10076
"RTN","PSBML",12,0)
 ;
"RTN","PSBML",13,0)
 ;*70 - store clinic name to admin location if exists.
"RTN","PSBML",14,0)
 ;    - add witness duz, dt/tm for high risk/alert drug, Order level
"RTN","PSBML",15,0)
 ;      HR code, and a witnessed y/n flag to MEDLOG file.
"RTN","PSBML",16,0)
 ;
"RTN","PSBML",17,0)
RPC(RESULTS,PSBHDR,PSBREC) ;BCMA MedLog Filing
"RTN","PSBML",18,0)
 K PSBEDTFL
"RTN","PSBML",19,0)
 S PSBEDTFL=0
"RTN","PSBML",20,0)
 N PSBORD,PSBTRAN,PSBFDA,PSBMES ;Add PSBMES variable for PSB*3*52
"RTN","PSBML",21,0)
 N PSBCLIN,PSBWITN,PSBWITCM,PSBWITHR,PSBWITFL,LOC  ;*70
"RTN","PSBML",22,0)
 K PSBIEN,PSBHL7,%,PSBAUDIT,PSBINST
"RTN","PSBML",23,0)
 S PSBIEN=$P(PSBHDR,U,1)
"RTN","PSBML",24,0)
 S PSBTRAN=$P(PSBHDR,U,2),PSBHL7=PSBTRAN
"RTN","PSBML",25,0)
 S PSBINST=$P($G(PSBHDR),U,3)
"RTN","PSBML",26,0)
 ;*70 witness fields
"RTN","PSBML",27,0)
 S PSBWITN=+$P(PSBHDR,U,4)                   ;init witness duz var
"RTN","PSBML",28,0)
 S PSBWITCM=$P(PSBHDR,U,5)                   ;init witness comment
"RTN","PSBML",29,0)
 S PSBWITHR=+$P(PSBHDR,U,6)                  ;init witness HR order level
"RTN","PSBML",30,0)
 S PSBWITFL=$S(PSBWITN:1,1:0)                ;init witnessed?
"RTN","PSBML",31,0)
 I PSBWITN="",PSBWITHR=3 D  Q
"RTN","PSBML",32,0)
 .S RESULTS(0)=1
"RTN","PSBML",33,0)
 .S RESULTS(1)="-1^A Witness is required, however Witness information was null."
"RTN","PSBML",34,0)
 ;PSB*3*45 We should be recording the first entry in the audit log.
"RTN","PSBML",35,0)
 ;S PSBAUDIT=$S(PSBIEN="+1":0,1:1)
"RTN","PSBML",36,0)
 S PSBAUDIT=1
"RTN","PSBML",37,0)
 D NOW^%DTC S PSBNOW=%
"RTN","PSBML",38,0)
 I $D(^XUSEC("PSB STUDENT",DUZ)),PSBINST="" S RESULTS(0)=1,RESULTS(1)="-1^Instructor not present" Q
"RTN","PSBML",39,0)
 I $D(^XUSEC("PSB STUDENT",DUZ)),'$D(^XUSEC("PSB INSTRUCTOR",PSBINST)) S RESULTS(0)=1,RESULTS(1)="-1^Instructor doesn't have authority" Q
"RTN","PSBML",40,0)
 S PSBINST(0)=$$GET1^DIQ(200,PSBINST_",",.01)
"RTN","PSBML",41,0)
 I PSBTRAN="ADD COMMENT" D COMMENT^PSBML1 Q
"RTN","PSBML",42,0)
 I PSBTRAN="PRN EFFECTIVENESS" D PRN^PSBML1 Q
"RTN","PSBML",43,0)
 ;
"RTN","PSBML",44,0)
 ;update medlog rec
"RTN","PSBML",45,0)
UPD I PSBTRAN="UPDATE STATUS" D  Q
"RTN","PSBML",46,0)
 .K PSBTAB,PSBUID
"RTN","PSBML",47,0)
 .I '$D(^PSB(53.79,PSBIEN)) D  Q
"RTN","PSBML",48,0)
 ..S RESULTS(0)=1
"RTN","PSBML",49,0)
 ..S RESULTS(1)="-1^Administration is at an UNKNOWN STATUS"
"RTN","PSBML",50,0)
 .D UPDATED^PSBML2
"RTN","PSBML",51,0)
 ;
"RTN","PSBML",52,0)
 ;edit Medlog rec
"RTN","PSBML",53,0)
 I PSBTRAN="EDIT" D EDIT^PSBML2 Q
"RTN","PSBML",54,0)
 ;
"RTN","PSBML",55,0)
 ;SAGG
"RTN","PSBML",56,0)
 N PSBWARD S PSBWARD=$G(^DPT(+$G(PSBREC(0)),.1),"UNKNOWN"),^PSB("SAGG",PSBWARD,DT)=$G(^PSB("SAGG",PSBWARD,DT))+1
"RTN","PSBML",57,0)
 ;*70 save clinic name if exists before manipulating PSBREC(1) param
"RTN","PSBML",58,0)
 S PSBCLIN=$P(PSBREC(1),U,2) I PSBCLIN="" S PSBCLIN=$S($G(PSBCLIEN):$P($G(^SC(+PSBCLIEN,0)),"^"),($G(PSBCLORD)]""):PSBCLORD,1:"")
"RTN","PSBML",59,0)
 S PSBREC(1)=$P(PSBREC(1),U)
"RTN","PSBML",60,0)
 ;
"RTN","PSBML",61,0)
 ;pre-existing psbrec(1) manipulation logic to *70
"RTN","PSBML",62,0)
 I PSBREC(1)?1U1";"1.6N S PSBREC(1)=$P(PSBREC(1),";",1)_$E(PSBREC(1))
"RTN","PSBML",63,0)
 D PSJ1^PSBVT(PSBREC(0),$P(PSBREC(1),";",2)_$P(PSBREC(1),";",1))
"RTN","PSBML",64,0)
 S PSBTAB=$P(PSBREC(9),U,1),PSBUID=$P(PSBREC(9),U,2)
"RTN","PSBML",65,0)
MEDP D:PSBTRAN="MEDPASS"
"RTN","PSBML",66,0)
 .K PSBDIV,PSBON,PSBXDT,PSBYZ
"RTN","PSBML",67,0)
 .I (PSBDOSEF["PATCH"),(PSBREC(3)="G") D  Q:+$G(RESULTS(1))<0
"RTN","PSBML",68,0)
 ..S PSBXDT="" F  S PSBXDT=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,PSBXDT)) Q:PSBXDT=""  D  Q:+$G(RESULTS(1))<0
"RTN","PSBML",69,0)
 ...S PSBYZ="" F  S PSBYZ=$O(^PSB(53.79,"AORDX",PSBDFN,PSBONX,PSBXDT,PSBYZ)) Q:'PSBYZ  I ("G"[$$GET1^DIQ(53.79,PSBYZ,.09,"I")) D  Q
"RTN","PSBML",70,0)
 ....S:($$GET1^DIQ(53.79,PSBYZ,.09,"I")="G") RESULTS(0)=1,RESULTS(1)="-1^Previous Patch has not been removed. Administration canceled."
"RTN","PSBML",71,0)
 ....S:($$GET1^DIQ(53.79,PSBYZ,.09,"I")="")&(($$GET1^DIQ(53.79,PSBYZ,.07,"I")'=DUZ)&('$D(^XUSEC("PSB MANAGER",DUZ)))) RESULTS(0)=1,RESULTS(1)="-1^Patch status ""*UNKNOWN*"". Administration canceled."
"RTN","PSBML",72,0)
 .I PSBREC(7)="BCMA/CPRS Interface Entry." S PSBNOW=PSBREC(5)  ;MOB
"RTN","PSBML",73,0)
 .F X=0:1:9 S PSBREC(X)=$G(PSBREC(X))
"RTN","PSBML",74,0)
 .I PSBREC(1)?1U1";".N S PSBREC(1)=$P(PSBREC(1),";",2)_$P(PSBREC(1),";",1)
"RTN","PSBML",75,0)
 .I PSBREC(1)["V",+PSBREC(5)>0,+$P(PSBREC(5),".",2)=0,PSBIVT'["P" D NOW^%DTC S PSBREC(5)=$P(PSBREC(5),".",1)_"."_$P(%,".",2)
"RTN","PSBML",76,0)
 .I $P(PSBREC(9),U,1)="IVTAB",$P(PSBREC(9),U,2)="" S PSBUID=$$GETWSID^PSBVDLU2(PSBREC(0),PSBREC(1))
"RTN","PSBML",77,0)
 .I $P(PSBREC(9),U,1)="PBTAB",$P(PSBREC(9),U,2)="",PSBREC(1)'["U",PSBREC(3)'="M",PSBREC(3)'="R",PSBREC(3)'="H" S PSBUID=$$GETWSID^PSBVDLU2(PSBREC(0),PSBREC(1))
"RTN","PSBML",78,0)
 .;OnCal
"RTN","PSBML",79,0)
 .D:PSBREC(2)="OC"
"RTN","PSBML",80,0)
 ..S X=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),"")) Q:X=""
"RTN","PSBML",81,0)
 ..S Y=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),X,0))
"RTN","PSBML",82,0)
 ..I $P(^PSB(53.79,Y,0),U,9)="G"&('$$GET^XPAR("DIV","PSB ADMIN MULTIPLE ONCALL")) D ERR(1,"On-Call already given")
"RTN","PSBML",83,0)
 .;1x
"RTN","PSBML",84,0)
 .D:PSBREC(2)="O"
"RTN","PSBML",85,0)
 ..S X=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),"")) Q:X=""
"RTN","PSBML",86,0)
 ..S Y=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),X,0))
"RTN","PSBML",87,0)
 ..I $P(^PSB(53.79,Y,0),U,9)="G" D ERR(1,"One Time already Given")
"RTN","PSBML",88,0)
 .;PRN
"RTN","PSBML",89,0)
 .I PSBREC(2)="P",PSBREC(3)'="M",$P(PSBREC(9),U,1)'="IVTAB" D
"RTN","PSBML",90,0)
 ..I PSBREC(6)="" D ERR(1,"PRN Medications MUST Have a PRN Reason")
"RTN","PSBML",91,0)
 ..I PSBREC(5)]"" D ERR(1,"PRN Orders don't have scheduled times")
"RTN","PSBML",92,0)
 ..I PSBREC(3)'="G" D ERR(1,"PRN Orders cannot be marked NOT Given")
"RTN","PSBML",93,0)
 .;Cnt
"RTN","PSBML",94,0)
 .I PSBREC(2)="C",PSBTAB'="IVTAB" D
"RTN","PSBML",95,0)
 ..D:PSBREC(5)="" ERR(1,"Continuous Order needs admin time")
"RTN","PSBML",96,0)
 ..D:PSBREC(6)]"" ERR(1,"No PRN Reason allowed on Continuous Orders")
"RTN","PSBML",97,0)
 .I PSBREC(2)="C",$D(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),+PSBREC(5))),PSBIEN="+1" D  K PSBADMBY,PSBADMAT Q:PSBSIEN=""  Q:$P(^PSB(53.79,PSBSIEN,0),U,9)'="N"
"RTN","PSBML",98,0)
 ..S PSBSIEN=$O(^PSB(53.79,"AORD",PSBREC(0),PSBREC(1),PSBREC(5),""))
"RTN","PSBML",99,0)
 ..I PSBSIEN]"" I '(($P(^PSB(53.79,PSBSIEN,0),U,7)=DUZ)!($D(^XUSEC("PSB MANAGER",DUZ)))) S PSBSIEN=""
"RTN","PSBML",100,0)
 ..I PSBSIEN']"" S RESULTS(0)=2,RESULTS(1)="-2^Error Filing Transaction MEDPASS",RESULTS(2)="The PSB MANAGER key is required to modify this scheduled admin" Q
"RTN","PSBML",101,0)
 ..D:$P(^PSB(53.79,PSBSIEN,0),U,9)'="N"
"RTN","PSBML",102,0)
 ...K PSBINCX I $P(^PSB(53.79,PSBSIEN,0),U,9)="" S PSBINCX=PSBSIEN L +^PSB(53.79,PSBINCX):1 Q:'$T  L -^PSB(53.79,PSBINCX)
"RTN","PSBML",103,0)
 ...S Y=$P(^PSB(53.79,PSBSIEN,0),U,6) D DD^%DT S PSBADMAT=Y
"RTN","PSBML",104,0)
 ...S PSBADMBY=$$GET1^DIQ(200,$P(^PSB(53.79,PSBSIEN,0),U,7),.01,)
"RTN","PSBML",105,0)
 ...S RESULTS(0)=3,RESULTS(1)="-2^Error Filing Transaction MEDPASS"
"RTN","PSBML",106,0)
 ...S RESULTS(2)="Continuous Administration Date/Time already on file."
"RTN","PSBML",107,0)
 ...S RESULTS(3)="Administered by "_PSBADMBY_" at "_PSBADMAT_"."
"RTN","PSBML",108,0)
 ...I $D(XWB) S RESULTS(0)=RESULTS(0)+2,RESULTS(4)="                                         ",RESULTS(5)="            VDL will now be updated."
"RTN","PSBML",109,0)
 .;Non Given
"RTN","PSBML",110,0)
 .I PSBREC(3)'="G",PSBREC(3)'="M",PSBUID'["V",PSBUID'["W" D
"RTN","PSBML",111,0)
 ..I PSBREC(7)="",PSBTAB'="IVTAB" D ERR(1,"Comment needed if Not Marked Given")
"RTN","PSBML",112,0)
 ..I PSBREC(7)="",PSBTAB="IVTAB" D ERR(1,"Comment needed if Not Marked Completed")
"RTN","PSBML",113,0)
 .S:PSBREC(3)="H" PSBREC(7)="Held: "_PSBREC(7)    ;.3
"RTN","PSBML",114,0)
 .S:PSBREC(3)="R" PSBREC(7)="Refused: "_PSBREC(7) ;.3
"RTN","PSBML",115,0)
 .S:PSBREC(3)="S" PSBREC(7)="Stopped: "_PSBREC(7) ;.3
"RTN","PSBML",116,0)
 .;Valid?
"RTN","PSBML",117,0)
 .I $G(PSBSIEN)'="" I $D(^PSB(53.79,PSBSIEN,0)) I $P(^PSB(53.79,PSBSIEN,0),U,9)="N" S PSBIEN=+PSBSIEN_",",$P(PSBHDR,U)=PSBIEN,PSBTRAN="UPDATE STATUS",PSBAUDIT=1                   ;do UPDATE
"RTN","PSBML",118,0)
 .D:PSBIEN="+1"                          ;New fields only?
"RTN","PSBML",119,0)
 ..D VAL(53.79,PSBIEN,.01,"`"_PSBREC(0))           ;Patn
"RTN","PSBML",120,0)
 ..S LOC=$G(^DPT(PSBREC(0),.1))_" "_$G(^(.101))    ;Ward Room/Bed LOC
"RTN","PSBML",121,0)
 ..S:PSBCLIN]"" LOC=PSBCLIN         ;If clinic order use clin name *70
"RTN","PSBML",122,0)
 ..D VAL(53.79,PSBIEN,.02,LOC)                     ;Patn Location LOC
"RTN","PSBML",123,0)
 ..D:$G(^DPT(PSBREC(0),.1))'=""
"RTN","PSBML",124,0)
 ...S Y=$O(^DIC(42,"B",$G(^DPT(PSBREC(0),.1)),"")),Y=$$GET1^DIQ(42,Y,.015,"I"),PSBDIV=$$SITE^VASITE(DT,Y)
"RTN","PSBML",125,0)
 ...D VAL(53.79,PSBIEN,.03,"`"_$P(PSBDIV,U,1))     ;Div
"RTN","PSBML",126,0)
 ..D VAL(53.79,PSBIEN,.04,PSBNOW)                  ;Entered dt/tm
"RTN","PSBML",127,0)
 ..D VAL(53.79,PSBIEN,.05,"`"_DUZ)                 ;Entered by duz
"RTN","PSBML",128,0)
 ..D VAL(53.79,PSBIEN,.06,PSBNOW)                  ;Admin dt/tm
"RTN","PSBML",129,0)
 ..D VAL(53.79,PSBIEN,.07,"`"_DUZ)                 ;Admin By duz
"RTN","PSBML",130,0)
 ..D VAL(53.79,PSBIEN,.08,"`"_PSBREC(4))           ;Orderable Item
"RTN","PSBML",131,0)
 ..D VAL(53.79,PSBIEN,.11,PSBREC(1))               ;Ord file 55 IEN
"RTN","PSBML",132,0)
 ..D VAL(53.79,PSBIEN,.12,PSBREC(2))               ;Ord Schd Type
"RTN","PSBML",133,0)
 ..D VAL(53.79,PSBIEN,.13,PSBREC(5))               ;Schd Adm dt/tm
"RTN","PSBML",134,0)
 ..D:PSBTAB'="UDTAB" VAL(53.79,PSBIEN,.26,PSBUID)  ;IV Bag ID
"RTN","PSBML",135,0)
 ..D:PSBTAB="IVTAB" VAL(53.79,PSBIEN,.13,"")       ;Schd Admdt/tm null
"RTN","PSBML",136,0)
 ..D:PSBREC(1)?.N1"U" VAL(53.79,PSBIEN,.15,PSBDOSE)  ;UD Dosage
"RTN","PSBML",137,0)
 ..D:PSBREC(1)?.N1"V" VAL(53.79,PSBIEN,.35,PSBIFR)   ;IV Infuse Rate
"RTN","PSBML",138,0)
 ..I PSBWITHR>1,(PSBREC(3)="G")!(PSBREC(3)="I") D          ;Witness logic and Give?  *70
"RTN","PSBML",139,0)
 ...D:PSBWITN VAL(53.79,PSBIEN,.28,PSBNOW)        ;Witness dt/time
"RTN","PSBML",140,0)
 ...D:PSBWITN VAL(53.79,PSBIEN,.29,"`"_PSBWITN)   ;Witness duz
"RTN","PSBML",141,0)
 ...D:PSBWITCM]"" VAL(53.79,PSBIEN,.31,PSBWITCM)  ;Witness comment
"RTN","PSBML",142,0)
 ...D VAL(53.79,PSBIEN,.32,PSBWITHR)              ;Witness HR ord code
"RTN","PSBML",143,0)
 ...D VAL(53.79,PSBIEN,.33,PSBWITFL)              ;Witnessed? flag
"RTN","PSBML",144,0)
 .;
"RTN","PSBML",145,0)
 .;Overwrite fields below, rec already exists
"RTN","PSBML",146,0)
 .I PSBREC(3)="G"!(PSBREC(3))="C" D                ;Gvn/Completed?
"RTN","PSBML",147,0)
 ..D VAL(53.79,PSBIEN,.06,PSBNOW)                    ;Admin dt/tm
"RTN","PSBML",148,0)
 ..D VAL(53.79,PSBIEN,.07,"`"_DUZ)                   ;Admin By duz
"RTN","PSBML",149,0)
 .D:PSBREC(8)]"" VAL(53.79,PSBIEN,.16,PSBREC(8))   ;InjctSte
"RTN","PSBML",150,0)
 .D:'$G(PSBMMEN) VAL(53.79,PSBIEN,.09,PSBREC(3))   ;AStats
"RTN","PSBML",151,0)
 .I PSBREC(6)]"" D                                 ;PRN reason?
"RTN","PSBML",152,0)
 ..D VAL(53.79,PSBIEN,.21,$P(PSBREC(6),U))           ;reason dt/tm
"RTN","PSBML",153,0)
 ..D VAL(53.79,PSBIEN,.27,$P(PSBREC(6),U,2))         ;PRN reason
"RTN","PSBML",154,0)
 .D:PSBREC(7)]""
"RTN","PSBML",155,0)
 ..D VAL(53.793,"+2,"_PSBIEN,.01,PSBREC(7))        ;Comment
"RTN","PSBML",156,0)
 ..D VAL(53.793,"+2,"_PSBIEN,.02,"`"_DUZ)          ;comnt person duz
"RTN","PSBML",157,0)
 ..D VAL(53.793,"+2,"_PSBIEN,.03,PSBNOW)           ;comnt dt/time
"RTN","PSBML",158,0)
 .;DD/SOL/ADD
"RTN","PSBML",159,0)
 .I PSBREC(3)="G"!(PSBREC(3)="I")!(PSBREC(3)="H")!(PSBREC(3)="R")!(PSBREC(3)="M") D     ;given/action stat codes?
"RTN","PSBML",160,0)
 ..I PSBTRAN="UPDATE STATUS" K ^PSB(53.79,+PSBIEN,.5),^PSB(53.79,+PSBIEN,.6),^PSB(53.79,+PSBIEN,.7)
"RTN","PSBML",161,0)
 ..K PSBCNT,PSBIENS
"RTN","PSBML",162,0)
 ..F PSBCNT=10:1 Q:'$D(PSBREC(PSBCNT))  D
"RTN","PSBML",163,0)
 ...S Y=$P(PSBREC(PSBCNT),U)
"RTN","PSBML",164,0)
 ...S PSBDD=$S(Y="DD":53.795,Y="ADD":53.796,Y="SOL":53.797,1:0)
"RTN","PSBML",165,0)
 ...Q:'PSBDD
"RTN","PSBML",166,0)
 ...S PSBIENS="+"_PSBCNT_","_PSBIEN
"RTN","PSBML",167,0)
 ...D VAL(PSBDD,PSBIENS,.01,"`"_$P(PSBREC(PSBCNT),U,2))
"RTN","PSBML",168,0)
 ...D VAL(PSBDD,PSBIENS,.02,$P(PSBREC(PSBCNT),U,3))
"RTN","PSBML",169,0)
 ...D:PSBDD=53.795 VAL(PSBDD,PSBIENS,.02,$P(PSBREC(PSBCNT),U,3))
"RTN","PSBML",170,0)
 ...D:PSBDD=53.796!(PSBDD=53.797) VAL(PSBDD,PSBIENS,.02,$P(PSBREC(PSBCNT),U,4)) ;Store units in Units ordered field, PSB*3*72
"RTN","PSBML",171,0)
 ...D:PSBREC(3)="G"!(PSBREC(3)="I") VAL(PSBDD,PSBIENS,.03,$P(PSBREC(PSBCNT),U,4)) ;only store units given when infusing or given, PSB*3*72
"RTN","PSBML",172,0)
 ...D:(PSBTAB="UDTAB")!(PSBTAB="PBTAB") VAL(PSBDD,PSBIENS,.04,$E($P(PSBREC(PSBCNT),U,5),1,40))
"RTN","PSBML",173,0)
 ...D VAL(PSBDD,PSBIENS,.05,$P(PSBREC(PSBCNT),U,7))        ;HR ind *70
"RTN","PSBML",174,0)
 .;Modify Filing Transaction Medpass error message too inclde details - PSB*3*52
"RTN","PSBML",175,0)
 .I $O(RESULTS("")) D  Q
"RTN","PSBML",176,0)
 ..N PSBERR
"RTN","PSBML",177,0)
 ..I $D(PSBMES) D
"RTN","PSBML",178,0)
 ...S RESULTS(1)="-2^***Your documentation is NOT being recorded in the patient record.***",RESULTS(2)=""
"RTN","PSBML",179,0)
 ...S RESULTS(3)="Please write down the information (below) AND contact your BCMA Coordinator or IT Support for assistance:",RESULTS(4)=""
"RTN","PSBML",180,0)
 ...S RESULTS(5)="Error(s) Filing Transaction MEDPASS"
"RTN","PSBML",181,0)
 ..S PSBERR=0 F  S PSBERR=$O(PSBMES(PSBERR)) Q:PSBERR=""  D
"RTN","PSBML",182,0)
 ...S RESULTS($O(RESULTS(""),-1)+1)=PSBMES(PSBERR),RESULTS(0)=$O(RESULTS(""),-1)
"RTN","PSBML",183,0)
 .;
"RTN","PSBML",184,0)
 .D FILEIT
"RTN","PSBML",185,0)
 .;
"RTN","PSBML",186,0)
 .;PSB*3*33
"RTN","PSBML",187,0)
 .D:((PSBREC(2)="O")!($$ONE^PSJBCMA(PSBREC(0),PSBREC(1))="O"))&(PSBREC(3)="G") EXPIRE^PSBML1  ;1x exp?
"RTN","PSBML",188,0)
 .D:(PSBREC(2)="O")&(PSBREC(3)="G") EXPIRE^PSBML1  ;1x exp?
"RTN","PSBML",189,0)
 .I $P(RESULTS(0),U,1)=1,PSBTAB'="UDTAB",PSBUID]"",PSBUID'["WS" S PSBON=+PSBREC(1) D EN^PSJBCMA3(PSBREC(0),PSBON,PSBUID,PSBREC(3),PSBNOW)
"RTN","PSBML",190,0)
 Q
"RTN","PSBML",191,0)
BCBU ;HL7,NatContng
"RTN","PSBML",192,0)
 Q:+$G(RESULTS(0))'>0
"RTN","PSBML",193,0)
 N PSBIEN1 S PSBIEN1=$S($P(PSBIEN,",",2)'="":+$P(PSBIEN,",",2),$G(PSBIEN)="+1":PSBIEN(1),1:+$G(PSBIEN))
"RTN","PSBML",194,0)
 I $G(PSBIEN1)="" S RESULTS(0)=1,RESULTS(1)="-1^Contingency NOT processed" Q
"RTN","PSBML",195,0)
 I $G(PSBIEN)="+1" S PSBHL7="MEDPASS"
"RTN","PSBML",196,0)
 E  S:$G(PSBHL7)="" PSBHL7="UPDATE STATUS"
"RTN","PSBML",197,0)
 D:('$D(Y(0))!($G(Y(0))="SAVE")!($G(Y(0))="YES")) EN^PSBSVHL7(+PSBIEN1,PSBHL7),MEDL^ALPBCBU(+PSBIEN1) K PSBHL7
"RTN","PSBML",198,0)
 ;<<HDR-VDEF(frm *3)
"RTN","PSBML",199,0)
 Q
"RTN","PSBML",200,0)
VAL(PSBDD,PSBIEN,PSBFLD,PSBVAL) ;
"RTN","PSBML",201,0)
 K ^TMP("DIERR",$J),PSBRET
"RTN","PSBML",202,0)
 D VAL^DIE(PSBDD,PSBIEN,PSBFLD,"F",PSBVAL,.PSBRET,"PSBFDA")
"RTN","PSBML",203,0)
 I PSBRET="^" F X=0:0 S X=$O(^TMP("DIERR",$J,X)) Q:'X  D ERR(2,^TMP("DIERR",$J,X)_": "_$G(^(X,"TEXT",1),"**"))
"RTN","PSBML",204,0)
 K ^TMP("DIERR",$J),PSBRET
"RTN","PSBML",205,0)
 Q
"RTN","PSBML",206,0)
FILEIT ;Updt
"RTN","PSBML",207,0)
 K Z,X,PSB1,PSB2
"RTN","PSBML",208,0)
 N PSBMSG,PSBAUD
"RTN","PSBML",209,0)
 S (PSB1,PSB2)=""
"RTN","PSBML",210,0)
 D APATCH^PSBML3
"RTN","PSBML",211,0)
 D CLEAN^DILF
"RTN","PSBML",212,0)
 D RESETADM^PSBUTL
"RTN","PSBML",213,0)
 D UPDATE^DIE("","PSBFDA","PSBIEN","PSBMSG")
"RTN","PSBML",214,0)
 I '$G(PSBMMEN) S X=+PSBIEN I $F("HR",$P(^PSB(53.79,X,0),U,9))>1 F Y=.5,.6,.7 S Z=0 F  S Z=$O(^PSB(53.79,+X,Y,Z)) Q:+Z=0  S $P(^PSB(53.79,+X,Y,Z,0),U,3)=0
"RTN","PSBML",215,0)
 I $D(PSBMSG("DIERR")) S RESULTS(0)=1,RESULTS(1)="-1^"_PSBMSG("DIERR",1)_": "_PSBMSG("DIERR",1,"TEXT",1)  Q
"RTN","PSBML",216,0)
 I $G(PSB1)]"" X PSB1 I $G(PSB2)]"" X PSB2
"RTN","PSBML",217,0)
 I $D(PSBHDR) D:"NHMR"[$P(^PSB(53.79,$S($P(PSBHDR,"^",1)="+1":PSBIEN(1),1:+PSBIEN),0),U,9)
"RTN","PSBML",218,0)
 .N PSBINDX S PSBINDX=$S($P(PSBHDR,"^",1)="+1":PSBIEN(1),1:+PSBIEN)
"RTN","PSBML",219,0)
 .K ^PSB(53.79,"APATCH",$P(^PSB(53.79,PSBINDX,0),U),$P(^PSB(53.79,PSBINDX,0),U,6),PSBINDX)
"RTN","PSBML",220,0)
 S RESULTS(0)=1,RESULTS(1)="1^Data Successfully Filed^"_$S($G(PSBIEN(1))'="":$G(PSBIEN(1)),1:+$G(PSBIEN))
"RTN","PSBML",221,0)
 D BCBU  ;NatContng
"RTN","PSBML",222,0)
 D  ;
"RTN","PSBML",223,0)
 . N X,DIC
"RTN","PSBML",224,0)
 . S X="PSB EVSEND VPR",DIC=101 D EN^XQOR ;should handle all BCMA Med Log events for VPR
"RTN","PSBML",225,0)
 I $G(PSBINST,0) S PSBAUD=$S($P(PSBHDR,"^",1)="+1":PSBIEN(1),1:$P(PSBHDR,"^",1)) D AUDIT^PSBMLU(PSBAUD,"Instructor "_PSBINST(0)_" present.",PSBTRAN)
"RTN","PSBML",226,0)
 Q
"RTN","PSBML",227,0)
ERR(X,Y) ;
"RTN","PSBML",228,0)
 S X=$P("Business Logic Error^Data Validation Error",U,X)
"RTN","PSBML",229,0)
 S RESULTS($O(RESULTS(""),-1)+1)=X_": "_Y
"RTN","PSBML",230,0)
 S PSBMES($O(PSBMES(""),-1)+1)=X_": "_Y
"RTN","PSBML",231,0)
 Q
"RTN","PSBML",232,0)
COMMENT(DA,PSBCMT) ;
"RTN","PSBML",233,0)
 N PSBFDA,PSBIEN,PSBNOW
"RTN","PSBML",234,0)
 S PSBIEN="+1,"_DA_","
"RTN","PSBML",235,0)
 D NOW^%DTC S PSBNOW=%
"RTN","PSBML",236,0)
 D VAL(53.793,PSBIEN,.01,PSBCMT)
"RTN","PSBML",237,0)
 S PSBFDA(53.793,PSBIEN,.02)=DUZ
"RTN","PSBML",238,0)
 S PSBFDA(53.793,PSBIEN,.03)=PSBNOW
"RTN","PSBML",239,0)
 D FILEIT
"RTN","PSBML",240,0)
 Q
"VER")
8.0^22.0
**END**
**END**

